const root=document.documentElement,savedTheme=localStorage.getItem("theme");async function loadPosts(){const t=document.getElementById("posts"),e=document.getElementById("latest-posts"),n=document.getElementById("tag-filter"),o=document.getElementById("search"),a=document.getElementById("tag-pills"),s=document.getElementById("result-count");if(!t&&!e)return;const c=await fetch("posts.json"),r=await c.json(),l=t=>(t||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),i=new URLSearchParams(location.search).get("tag")||"";if(n){const g=Array.from(new Set(r.flatMap(t=>t.tags))).sort();for(const h of g){const u=document.createElement("option");u.value=h,u.textContent=h,n.appendChild(u)}}if(a){const f=r.flatMap(t=>t.tags).reduce((t,e)=>(t[e]=(t[e]||0)+1,t),{});Object.entries(f).sort((t,e)=>e[1]-t[1]).slice(0,10).map(([t])=>t).forEach(t=>{const e=document.createElement("button");e.type="button",e.className="tag-pill"+(t===i?" active":""),e.dataset.tag=t,e.textContent=t,a.appendChild(e)})}if(e){r.slice(0,3).forEach(t=>e.appendChild(m(t)))}if(t){let E=1,y=9,v=i,L="",C=[];n&&(n.value=v);const w=document.getElementById("load-more");function d(){t.innerHTML="";const e=r.filter(t=>!v||t.tags.includes(v)).map(t=>{const e=l(t.title+" "+t.excerpt),n=C.reduce((t,n)=>t+(e.includes(n)?1:0),0);return{...t,score:n}}).filter(t=>!C.length||t.score>0).sort((t,e)=>C.length&&e.score!==t.score?e.score-t.score:new Date(e.date)-new Date(t.date));e.slice(0,E*y).forEach(e=>t.appendChild(m(e,C))),w.style.display=e.length>E*y?"inline-flex":"none",s&&(s.textContent=`${e.length} résultats`),a&&[...a.children].forEach(t=>t.classList.toggle("active",t.dataset.tag===v))}n?.addEventListener("change",t=>{v=t.target.value,E=1,d()}),a?.addEventListener("click",t=>{const e=t.target.closest(".tag-pill");e&&(v=e.dataset.tag,n&&(n.value=v),E=1,d())}),o?.addEventListener("input",t=>{L=t.target.value||"",C=l(L).split(/\s+/).filter(Boolean),E=1,d()}),document.getElementById("load-more")?.addEventListener("click",()=>{E++,d()}),d()}function m(t,e=[]){const n=document.createElement("article");n.className="card";const o=p(t.title,e),a=p(t.excerpt,e);return n.innerHTML=`\n      <div class="meta">${t.date} • ${t.tags.join(", ")}</div>\n      <h3><a href="post.html?id=${encodeURIComponent(t.id)}">${o}</a></h3>\n      <p>${a}</p>\n      <a class="arrow" href="post.html?id=${encodeURIComponent(t.id)}">Lire →</a>\n    `,n}function p(t,e){if(!e.length)return t;const n=l(t),o=[];for(const t of e){let e=0;for(;;){const a=n.indexOf(t,e);if(-1===a)break;o.push({start:a,end:a+t.length}),e=a+t.length}}if(!o.length)return t;o.sort((t,e)=>t.start-e.start);const a=[];for(const t of o){const e=a[a.length-1];e&&t.start<e.end?e.end=Math.max(e.end,t.end):a.push({...t})}let s="",c=0;for(const e of a)s+=t.slice(c,e.start)+"<mark>"+t.slice(e.start,e.end)+"</mark>",c=e.end;return s+=t.slice(c),s}}async function loadPost(){if(!document.getElementById("post-article"))return;const t=new URLSearchParams(location.search).get("id"),e=await(await fetch("posts.json")).json(),n=e.find(e=>e.id===t)||e[0];document.title=n.title+" — Robin",document.getElementById("post-title").textContent=n.title;const o=document.getElementById("post-meta"),a=document.getElementById("post-cover");if(n.cover){const t=document.createElement("img");t.src=n.cover,t.loading="lazy",t.alt="",t.style.borderRadius="18px",t.style.width="100%",t.style.height="auto",a.innerHTML="",a.appendChild(t)}document.getElementById("post-content").innerHTML=n.content.split("\n\n").map(t=>{if(t.startsWith("```")){const n=t.replace(/^```[a-z]*\n?|```$/g,"").replace(/```$/,"");return`<pre class="card"><code>${e=n,e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}</code></pre>`}var e;return`<p>${t}</p>`}).join("");const s=((n.content||"").replace(/```[\s\S]*?```/g,"").match(/\S+/g)||[]).length,c=Math.max(1,Math.round(s/220));o&&(o.textContent=`${n.date} • ${n.tags.join(", ")} • ${c} min`),document.querySelectorAll("#post-content pre").forEach(t=>{const e=document.createElement("button");e.className="copy-btn",e.type="button",e.textContent="Copier",e.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(t.textContent),e.textContent="Copié !",setTimeout(()=>e.textContent="Copier",1200)}catch(t){}}),t.appendChild(e)});const r=document.getElementById("read-progress");if(r){const t=document.getElementById("post-article"),e=()=>{const e=t.scrollHeight-window.innerHeight,n=Math.min(Math.max(window.scrollY-t.offsetTop,0),e);r.style.width=(e>0?n/e*100:0).toFixed(2)+"%"};window.addEventListener("scroll",e,{passive:!0}),e()}const l=e.filter(t=>t.id!==n.id&&t.tags.some(t=>n.tags.includes(t))).slice(0,3),i=document.getElementById("related");i.innerHTML="",l.forEach(t=>{const e=document.createElement("article");e.className="card",e.innerHTML=`<h3><a href="post.html?id=${encodeURIComponent(t.id)}">${t.title}</a></h3><p class="meta">${t.date} • ${t.tags.join(", ")}</p>`,i.appendChild(e)});const d={"@context":"https://schema.org","@type":"Article",headline:n.title,description:n.excerpt||n.title,datePublished:n.date,author:{"@type":"Person",name:"Robin"},mainEntityOfPage:location.href},m=document.getElementById("ld-article");m&&(m.textContent=JSON.stringify(d,null,2))}"light"===savedTheme&&root.classList.add("light"),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("theme-toggle");t&&t.addEventListener("click",()=>{root.classList.toggle("light"),localStorage.setItem("theme",root.classList.contains("light")?"light":"dark")})}),loadPosts(),loadPost(),function(){if(!("relList"in HTMLLinkElement.prototype&&HTMLLinkElement.prototype.relList.supports?.("prefetch")))return;document.addEventListener("mouseover",t=>{const e=t.target.closest("a[href]");if(!e||!(t=>{try{return new URL(t,location.href).origin===location.origin}catch{return!1}})(e.href))return;const n=document.createElement("link");n.rel="prefetch",n.href=e.href,n.as="document",document.head.appendChild(n)},{passive:!0})}(),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js");